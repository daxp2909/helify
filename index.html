<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Helify MVP - Clinical Precision</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #0f172a; color: white; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .app-container { display: flex; flex-direction: column; align-items: center; padding: 20px; width: 100%; max-width: 1400px; }
        
        .leg-toggle { position: fixed; top: 20px; left: 20px; z-index: 100; background: #1e293b; padding: 8px; border-radius: 20px; display: flex; gap: 5px; border: 1px solid #334155; }
        .mode-btn { padding: 8px 16px; border-radius: 15px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; }
        .mode-btn.active { background: #22d3ee; color: #0f172a; }
        
        .status-indicator { position: fixed; top: 20px; right: 20px; z-index: 100; background: #1e293b; padding: 10px 20px; border-radius: 20px; border: 1px solid #334155; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite; }
        .status-dot.searching { background: #f59e0b; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .video-box { position: relative; border: 4px solid #334155; border-radius: 20px; overflow: hidden; background: #000; width: 100%; aspect-ratio: 16/9; max-height: 65vh; margin-top: 60px; }
        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        #ui-layer { position: absolute; top: 20px; left: 20px; pointer-events: none; width: calc(100% - 40px); }
        .metrics-grid { display: flex; gap: 12px; flex-wrap: wrap; }
        .metric-card { background: rgba(15, 23, 42, 0.95); padding: 12px 16px; border-radius: 12px; border: 1px solid #334155; min-width: 90px; backdrop-filter: blur(8px); }
        .label { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .value { font-size: 22px; font-weight: bold; color: #22d3ee; }
        .value.warning { color: #f59e0b; }
        .value.danger { color: #ef4444; }
        .sub-value { font-size: 11px; color: #cbd5e1; margin-top: 2px; }
        
        #coaching-overlay { 
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); color: white; padding: 16px 32px; border-radius: 16px;
            font-size: 20px; font-weight: 700; text-align: center; border: 2px solid #22d3ee;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s;
            max-width: 80%; line-height: 1.4;
        }
        #coaching-overlay.show { opacity: 1; }
        #coaching-overlay.success { border-color: #22c55e; color: #4ade80; }
        #coaching-overlay.warning { border-color: #f59e0b; color: #fbbf24; }
        #coaching-overlay.danger { border-color: #ef4444; color: #f87171; }

        #timeout-bar {
            position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
            opacity: 0; transition: opacity 0.3s;
        }
        #timeout-bar.show { opacity: 1; }
        #timeout-progress {
            height: 100%; background: #ef4444; border-radius: 2px;
            width: 0%; transition: width 0.1s linear;
        }
        
        #feedback-toast { 
            position: absolute; top: 20px; right: 150px; 
            background: rgba(34, 211, 238, 0.95); color: #0f172a;
            padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 14px;
            transform: translateX(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        #feedback-toast.show { transform: translateX(0); }
        
        #warning-box { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 24px; border-radius: 30px; font-weight: bold; display: none; font-size: 14px; }
        
        #action-bar { margin-top: 20px; display: flex; gap: 15px; width: 100%; justify-content: center; }
        .btn { padding: 14px 32px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 16px; }
        .btn-finish { background: #22c55e; color: white; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3); }
        .btn-finish:hover { background: #16a34a; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        
        .history-section { width: 100%; margin-top: 30px; background: #1e293b; border-radius: 16px; padding: 25px; border: 1px solid #334155; }
        .history-section h3 { margin-top: 0; color: #e2e8f0; border-bottom: 1px solid #334155; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: left; color: #94a3b8; padding: 12px; border-bottom: 1px solid #334155; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #334155; color: #f1f5f9; }
        .score-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 12px; }
        .score-good { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .score-mid { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .score-poor { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        #report-modal.show { display: flex; }
        .report-content { background: #1e293b; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; }
        .report-header { background: #0f172a; padding: 25px; border-radius: 20px 20px 0 0; border-bottom: 1px solid #334155; }
        .report-header h2 { margin: 0 0 5px 0; color: #e2e8f0; }
        .report-header .subtitle { color: #94a3b8; font-size: 14px; }
        .report-body { padding: 25px; }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .report-card { background: #0f172a; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .report-card h4 { margin: 0 0 10px 0; color: #94a3b8; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .report-card .big-number { font-size: 32px; font-weight: bold; color: #22d3ee; margin: 5px 0; }
        .report-card .comparison { font-size: 13px; color: #64748b; margin-top: 5px; }
        .report-card .comparison.positive { color: #4ade80; }
        .report-card .comparison.negative { color: #f87171; }
        
        .issues-list { background: #0f172a; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .issues-list h4 { margin: 0 0 15px 0; color: #e2e8f0; }
        .issue-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #cbd5e1; font-size: 14px; }
        .issue-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        .issue-dot.warning { background: #f59e0b; }
        
        .recommendation-box { background: rgba(34, 211, 238, 0.1); border: 1px solid #22d3ee; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .recommendation-box h4 { margin: 0 0 10px 0; color: #22d3ee; }
        .recommendation-box ul { margin: 0; padding-left: 20px; color: #cbd5e1; font-size: 14px; line-height: 1.8; }
        
        .report-actions { display: flex; flex-direction: column; gap: 15px; padding: 0 25px 25px; }
        
        .rep-panel { margin-top: 20px; background: #1e293b; border-radius: 16px; padding: 20px; border: 1px solid #334155; width: 100%; }
        .rep-table { width: 100%; font-size: 13px; max-height: 300px; overflow-y: auto; }
        .rep-table th, .rep-table td { padding: 10px; font-size: 12px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .badge-warn { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        
        .score-display { position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.95); padding: 15px 20px; border-radius: 12px; border: 1px solid #334155; text-align: center; }
        .score-display .score-value { font-size: 36px; font-weight: bold; color: #22d3ee; }
        .score-display .score-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }

        #debug-info { position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; font-size: 12px; max-width: 300px; display: none; }
    </style>
</head>
<body>

<div class="leg-toggle">
    <button class="mode-btn active" onclick="setLeg('left')" id="btn-left">Left Leg</button>
    <button class="mode-btn" onclick="setLeg('right')" id="btn-right">Right Leg</button>
</div>

<div class="status-indicator" id="status-indicator">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text">Searching for patient...</span>
</div>

<div class="app-container">
    <div class="video-box">
        <video id="input_video" style="display:none;"></video>
        <canvas id="output_canvas" width="1280" height="720"></canvas>
        
        <div id="ui-layer">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="label">Valid Reps</div>
                    <div id="rep_count" class="value">0</div>
                    <div class="sub-value" id="rep_ratio">0/0</div>
                </div>
                <div class="metric-card">
                    <div class="label">Flexion Angle</div>
                    <div id="angle_display" class="value">0¬∞</div>
                    <div class="sub-value">0¬∞ = straight leg</div>
                </div>
                <div class="metric-card">
                    <div class="label">Hip Stability</div>
                    <div id="hip_stability" class="value">--</div>
                    <div class="sub-value">Variance: <span id="hip_var">0</span>%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Smoothness</div>
                    <div id="smoothness" class="value">--</div>
                    <div class="sub-value">Jerk: <span id="jerk_val">0</span></div>
                </div>
                <div class="metric-card">
                    <div class="label">Rep Time</div>
                    <div id="rep_time" class="value">--</div>
                    <div class="sub-value">Target: 2-4s</div>
                </div>
            </div>
        </div>

        <div id="coaching-overlay">Position patient leg toward camera</div>
        <div id="timeout-bar"><div id="timeout-progress"></div></div>
        <div id="feedback-toast"></div>
        <div id="warning-box">‚ö†Ô∏è Patient leg not visible</div>
        
        <div class="score-display">
            <div class="score-value" id="current-score">--</div>
            <div class="score-label">Quality Score</div>
        </div>
    </div>

    <div id="action-bar">
        <button class="btn btn-finish" onclick="finishSession()" id="finish-btn">Finish Session</button>
    </div>

    <div class="rep-panel">
        <h3 style="margin-top:0;color:#e2e8f0;">Rep-by-Rep Analysis</h3>
        <div style="overflow-x:auto;">
            <table class="rep-table">
                <thead>
                    <tr>
                        <th>Rep #</th>
                        <th>Status</th>
                        <th>Min Angle</th>
                        <th>ROM</th>
                        <th>Duration</th>
                        <th>Smoothness</th>
                        <th>Hip Stability</th>
                        <th>Quality Score</th>
                        <th>Issue</th>
                    </tr>
                </thead>
                <tbody id="rep-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="history-section">
        <h3>üìä Session History <span style="font-weight:normal;font-size:14px;color:#64748b;">(Last 10 sessions)</span></h3>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Leg</th>
                    <th>Reps (Valid/Total)</th>
                    <th>Avg ROM</th>
                    <th>Best ROM</th>
                    <th>Quality Score</th>
                    <th>Issues</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>
</div>

<div id="report-modal">
    <div class="report-content">
        <div class="report-header">
            <h2>üè• Helify Exercise Report</h2>
            <div class="subtitle" id="report-subtitle">Session Summary</div>
        </div>
        <div class="report-body">
            <div class="report-grid">
                <div class="report-card">
                    <h4>Valid Reps</h4>
                    <div class="big-number" id="report-valid">0</div>
                    <div class="comparison" id="report-rep-trend">--</div>
                </div>
                <div class="report-card">
                    <h4>Success Rate</h4>
                    <div class="big-number" id="report-rate">0%</div>
                </div>
                <div class="report-card">
                    <h4>Average ROM</h4>
                    <div class="big-number" id="report-rom">0¬∞</div>
                    <div class="comparison" id="report-rom-trend">--</div>
                </div>
                <div class="report-card">
                    <h4>Quality Score</h4>
                    <div class="big-number" id="report-score">0</div>
                    <div class="comparison" id="report-score-trend">--</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div class="report-card">
                    <h4>Avg Rep Time</h4>
                    <div style="font-size: 24px; font-weight: bold; color: #e2e8f0;" id="report-time">0s</div>
                </div>
                <div class="report-card">
                    <h4>Best ROM</h4>
                    <div style="font-size: 24px; font-weight: bold; color: #e2e8f0;" id="report-best">0¬∞</div>
                </div>
            </div>
            
            <div class="issues-list">
                <h4>‚ö†Ô∏è Top Issues Detected</h4>
                <div id="issues-container"></div>
            </div>
            
            <div class="recommendation-box">
                <h4>üí° Suggested Next Focus</h4>
                <ul id="recommendations-list"></ul>
            </div>
        </div>
        <div class="report-actions">
            <div style="display: flex; gap: 10px; width: 100%;">
                <input type="email" id="user-email" placeholder="Enter your email address" 
                       style="flex: 1; padding: 12px 16px; border-radius: 8px; border: 1px solid #334155; 
                              background: #0f172a; color: white; font-size: 14px;" required>
            </div>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn btn-share" onclick="downloadPDF()" style="flex: 1; background: #334155; color: white;">
                    ‚¨áÔ∏è Download PDF
                </button>
                <button class="btn btn-finish" onclick="sendPDFByEmail()" id="send-email-btn" style="flex: 1;">
                    üìß Send to Email
                </button>
            </div>
            <button class="btn btn-close" onclick="closeReport()" style="width: 100%; background: #475569; color: white;">Close</button>
        </div>
        <div id="email-status" style="text-align: center; font-size: 13px; padding-bottom: 15px; min-height: 20px; color: #94a3b8;"></div>
    </div>
</div>

<div id="debug-info"></div>

<script>
    // ============ EMAILJS CONFIGURATION ============
    const EMAILJS_CONFIG = {
        PUBLIC_KEY: 'kOK8eC78MK7kSaNWJ',
        SERVICE_ID: 'service_15agqao',
        TEMPLATE_ID: 'template_stcbsh6'
    };

    // Initialize EmailJS with error handling
    (function() {
        try {
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            console.log('EmailJS initialized successfully');
        } catch (error) {
            console.error('EmailJS init failed:', error);
        }
    })();

    // ============ CONFIGURATION ============
    const CONFIG = {
        ROM: { 
            STAND_THRESHOLD: 15,
            DEEP_THRESHOLD: 70,
            MAX_SAFE: -5
        },
        SPEED: { 
            MIN_TIME: 2.0,
            MAX_TIME: 6.0,
            OPTIMAL_MIN: 2.5,
            OPTIMAL_MAX: 4.0
        },
        STABILITY: {
            HIP_THRESHOLD: 0.03,
            SMOOTHNESS_WINDOW: 10,
            JERK_THRESHOLD: 15
        },
        TIMEOUT: 8.0,
        SCORING: {
            ROM_WEIGHT: 0.40,
            TEMPO_WEIGHT: 0.30,
            CONTROL_WEIGHT: 0.30
        },
        DETECTION: {
            MIN_VISIBILITY: 0.6,
            CONFIRMATION_FRAMES: 10
        }
    };

    // ============ STATE ============
    let state = {
        leg: 'left',
        
        patientLocked: false,
        patientConfirmationCount: 0,
        selectedLegIndices: null,
        
        phase: 'STANDING',
        repStartTime: 0,
        validReps: 0,
        totalRepsAttempted: 0,
        
        currentRepMinAngle: 180,
        currentRepMaxFlexion: 0,
        currentRepStartHipY: 0,
        currentRepHipVariance: 0,
        currentRepHyperextended: false,
        
        angleHistory: [],
        lastAngle: 180,
        lastVelocity: 0,
        maxJerk: 0,
        
        sumRoM: 0,
        sumDuration: 0,
        bestROM: 0,
        totalScore: 0,
        repLogs: [],
        
        hyperextensionCount: 0,
        hipStabilityFails: 0,
        jerkFails: 0,
        
        issues: {
            incompleteROM: 0,
            tooFast: 0,
            tooSlow: 0,
            hyperextension: 0,
            hipStability: 0,
            jerky: 0
        }
    };

    let currentSessionData = null;

    // ============ DOM ELEMENTS ============
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    const elAngle = document.getElementById('angle_display');
    const elReps = document.getElementById('rep_count');
    const elRepRatio = document.getElementById('rep_ratio');
    const elHipStability = document.getElementById('hip_stability');
    const elHipVar = document.getElementById('hip_var');
    const elSmoothness = document.getElementById('smoothness');
    const elJerkVal = document.getElementById('jerk_val');
    const elRepTime = document.getElementById('rep_time');
    const elCoaching = document.getElementById('coaching-overlay');
    const elToast = document.getElementById('feedback-toast');
    const elCurrentScore = document.getElementById('current-score');
    const elTimeoutBar = document.getElementById('timeout-bar');
    const elTimeoutProgress = document.getElementById('timeout-progress');
    const elStatusDot = document.getElementById('status-dot');
    const elStatusText = document.getElementById('status-text');

    // ============ INITIALIZATION ============
    function init() {
        const savedLeg = localStorage.getItem('helify_leg');
        if (savedLeg) setLeg(savedLeg);
        else updateLegIndices();
        
        renderHistory();
    }

    function setLeg(leg) {
        state.leg = leg;
        localStorage.setItem('helify_leg', leg);
        
        document.getElementById('btn-left').classList.toggle('active', leg === 'left');
        document.getElementById('btn-right').classList.toggle('active', leg === 'right');
        
        updateLegIndices();
        resetSession();
        showFeedback(`Switched to ${leg} leg`, 'neutral');
    }

    function updateLegIndices() {
        if (state.leg === 'left') {
            state.selectedLegIndices = { hip: 23, knee: 25, ankle: 27 };
        } else {
            state.selectedLegIndices = { hip: 24, knee: 26, ankle: 28 };
        }
    }

    function resetSession() {
        state.patientLocked = false;
        state.patientConfirmationCount = 0;
        state.phase = 'STANDING';
        state.validReps = 0;
        state.totalRepsAttempted = 0;
        state.sumRoM = 0;
        state.sumDuration = 0;
        state.bestROM = 0;
        state.totalScore = 0;
        state.repLogs = [];
        state.hyperextensionCount = 0;
        state.hipStabilityFails = 0;
        state.jerkFails = 0;
        state.issues = {
            incompleteROM: 0, tooFast: 0, tooSlow: 0,
            hyperextension: 0, hipStability: 0, jerky: 0
        };
        resetRepTracking();
        updateUI();
        document.getElementById('rep-table-body').innerHTML = '';
        hideTimeoutBar();
        updateStatus('searching');
    }

    function resetRepTracking() {
        state.angleHistory = [];
        state.lastAngle = 180;
        state.lastVelocity = 0;
        state.maxJerk = 0;
        state.currentRepHyperextended = false;
        state.currentRepHipVariance = 0;
    }

    function updateStatus(status) {
        if (status === 'locked') {
            elStatusDot.classList.remove('searching');
            elStatusText.textContent = 'Patient detected';
        } else {
            elStatusDot.classList.add('searching');
            elStatusText.textContent = 'Searching for patient...';
        }
    }

    function showCoaching(text, type = 'neutral') {
        elCoaching.textContent = text;
        elCoaching.className = 'show ' + type;
        
        if (type !== 'danger') {
            setTimeout(() => {
                if (elCoaching.textContent === text) {
                    elCoaching.classList.remove('show');
                }
            }, 3000);
        }
    }

    function showFeedback(text, type = 'neutral') {
        elToast.textContent = text;
        elToast.className = 'show';
        setTimeout(() => elToast.classList.remove('show'), 2500);
    }

    function showTimeoutBar() {
        elTimeoutBar.classList.add('show');
    }

    function hideTimeoutBar() {
        elTimeoutBar.classList.remove('show');
        elTimeoutProgress.style.width = '0%';
    }

    function updateTimeoutProgress(elapsed) {
        const progress = (elapsed / CONFIG.TIMEOUT) * 100;
        elTimeoutProgress.style.width = Math.min(progress, 100) + '%';
    }

    function checkTimeout(now) {
        if (state.phase === 'STANDING') return false;
        
        const elapsed = now - state.repStartTime;
        updateTimeoutProgress(elapsed);
        
        if (elapsed > CONFIG.TIMEOUT) {
            state.phase = 'STANDING';
            state.totalRepsAttempted++;
            resetRepTracking();
            hideTimeoutBar();
            
            const repLog = {
                repNumber: state.totalRepsAttempted,
                isValid: false,
                minAngle: 180,
                rom: 0,
                duration: elapsed.toFixed(1),
                smoothness: 'N/A',
                hipStable: 'N/A',
                qualityScore: 0,
                reason: 'Timeout (incomplete)'
            };
            state.repLogs.push(repLog);
            addRepToTable(repLog);
            
            showCoaching("Rep cancelled - took too long", "warning");
            updateUI();
            return true;
        }
        return false;
    }

    function updateSmoothness(angle) {
        const velocity = angle - state.lastAngle;
        const jerk = Math.abs(velocity - state.lastVelocity);
        
        state.angleHistory.push({ angle, velocity, jerk });
        if (state.angleHistory.length > CONFIG.STABILITY.SMOOTHNESS_WINDOW) {
            state.angleHistory.shift();
        }
        
        state.maxJerk = Math.max(state.maxJerk, jerk);
        state.lastAngle = angle;
        state.lastVelocity = velocity;
        
        return jerk;
    }

    function getSmoothnessScore() {
        if (state.angleHistory.length < 5) return 100;
        const avgJerk = state.angleHistory.reduce((a, b) => a + b.jerk, 0) / state.angleHistory.length;
        return Math.max(0, 100 - (avgJerk * 5));
    }

    function isJerky() {
        return state.maxJerk > CONFIG.STABILITY.JERK_THRESHOLD;
    }

    function updateHipStability(currentHipY) {
        if (state.phase === 'DESCENDING' || state.phase === 'ASCENDING') {
            const variance = Math.abs(currentHipY - state.currentRepStartHipY);
            state.currentRepHipVariance = Math.max(state.currentRepHipVariance, variance);
        }
        return state.currentRepHipVariance;
    }

    function isHipStable() {
        return state.currentRepHipVariance < CONFIG.STABILITY.HIP_THRESHOLD;
    }

    function toAnatomical(geometricAngle) {
        return Math.max(0, Math.min(180, 180 - geometricAngle));
    }

    function calculateRepQuality(duration, rom, smoothnessScore, hipStable, hyperextended) {
        let score = 0;
        
        const romPercent = Math.min(100, (rom / 70) * 100);
        score += romPercent * CONFIG.SCORING.ROM_WEIGHT;
        
        let tempoScore = 0;
        if (duration >= CONFIG.SPEED.OPTIMAL_MIN && duration <= CONFIG.SPEED.OPTIMAL_MAX) {
            tempoScore = 100;
        } else if (duration >= CONFIG.SPEED.MIN_TIME && duration <= CONFIG.SPEED.MAX_TIME) {
            tempoScore = 70;
        } else {
            tempoScore = 40;
        }
        score += tempoScore * CONFIG.SCORING.TEMPO_WEIGHT;
        
        let controlScore = smoothnessScore;
        if (!hipStable) controlScore *= 0.7;
        if (hyperextended) controlScore *= 0.5;
        score += controlScore * CONFIG.SCORING.CONTROL_WEIGHT;
        
        return Math.round(score);
    }

    function getCoachingCue(valid, issues) {
        if (!valid) {
            if (issues.hyperextension) return "Don't lock knee fully";
            if (issues.jerky) return "Control movement, don't swing";
            if (issues.hipStability) return "Keep hip steady";
            if (issues.incompleteROM) return "Bend knee more";
            if (issues.tooFast) return "Slow down";
            if (issues.tooSlow) return "Maintain pace";
        }
        return "Excellent! Keep going";
    }

    function selectPatient(landmarks) {
        const idx = state.selectedLegIndices;
        const hip = landmarks[idx.hip];
        const knee = landmarks[idx.knee];
        const ankle = landmarks[idx.ankle];
        
        if (hip.visibility < CONFIG.DETECTION.MIN_VISIBILITY || 
            knee.visibility < CONFIG.DETECTION.MIN_VISIBILITY || 
            ankle.visibility < CONFIG.DETECTION.MIN_VISIBILITY) {
            return null;
        }
        
        state.patientConfirmationCount++;
        if (state.patientConfirmationCount >= CONFIG.DETECTION.CONFIRMATION_FRAMES) {
            state.patientLocked = true;
            updateStatus('locked');
        }
        
        return { hip, knee, ankle };
    }

    function processFrame(landmarks) {
        const now = performance.now() / 1000;
        
        if (checkTimeout(now)) return null;
        
        const patient = selectPatient(landmarks);
        if (!patient) {
            document.getElementById('warning-box').style.display = 'block';
            state.patientLocked = false;
            state.patientConfirmationCount = 0;
            updateStatus('searching');
            return null;
        }
        
        document.getElementById('warning-box').style.display = 'none';
        
        const { hip, knee, ankle } = patient;
        const geometricAngle = calculateAngle(hip, knee, ankle);
        const anatomicalAngle = toAnatomical(geometricAngle);
        const jerk = updateSmoothness(geometricAngle);
        const smoothnessScore = getSmoothnessScore();
        
        elAngle.textContent = Math.round(anatomicalAngle) + "¬∞";
        elJerkVal.textContent = state.maxJerk.toFixed(1);
        elSmoothness.textContent = smoothnessScore > 80 ? 'Good' : smoothnessScore > 50 ? 'Fair' : 'Poor';
        elSmoothness.className = 'value ' + (smoothnessScore > 80 ? '' : smoothnessScore > 50 ? 'warning' : 'danger');
        
        let isSafe = true;
        if (anatomicalAngle < CONFIG.ROM.MAX_SAFE) {
            showCoaching("Don't lock knee fully", "danger");
            elAngle.classList.add('danger');
            isSafe = false;
            state.currentRepHyperextended = true;
        } else {
            elAngle.classList.remove('danger');
        }
        
        if (state.phase === 'STANDING' && anatomicalAngle > CONFIG.ROM.STAND_THRESHOLD) {
            state.phase = 'DESCENDING';
            state.repStartTime = now;
            state.currentRepMinAngle = geometricAngle;
            state.currentRepMaxFlexion = anatomicalAngle;
            state.currentRepStartHipY = hip.y;
            state.currentRepHipVariance = 0;
            state.currentRepHyperextended = false;
            state.maxJerk = 0;
            state.angleHistory = [];
            
            showTimeoutBar();
            showCoaching("Lower slowly...", "neutral");
        }
        
        if (state.phase === 'DESCENDING' || state.phase === 'ASCENDING') {
            if (anatomicalAngle > state.currentRepMaxFlexion) {
                state.currentRepMaxFlexion = anatomicalAngle;
                state.currentRepMinAngle = geometricAngle;
            }
            
            const hipVar = updateHipStability(hip.y);
            elHipVar.textContent = (hipVar * 100).toFixed(1);
            elHipStability.textContent = hipVar < CONFIG.STABILITY.HIP_THRESHOLD ? 'Stable' : 'Unstable';
            elHipStability.className = 'value ' + (hipVar < CONFIG.STABILITY.HIP_THRESHOLD ? '' : 'warning');
            
            if (state.phase === 'DESCENDING' && anatomicalAngle > CONFIG.ROM.DEEP_THRESHOLD) {
                state.phase = 'ASCENDING';
                showCoaching("Now extend slowly", "neutral");
            }
        }
        
        if (state.phase === 'ASCENDING' && anatomicalAngle < CONFIG.ROM.STAND_THRESHOLD) {
            finishRep(now, smoothnessScore);
        }
        
        if (state.phase !== 'STANDING') {
            const elapsed = now - state.repStartTime;
            elRepTime.textContent = elapsed.toFixed(1) + "s";
        }
        
        return { isSafe, hip, knee, ankle, smoothnessScore };
    }

    function finishRep(now, smoothnessScore) {
        state.phase = 'STANDING';
        hideTimeoutBar();
        state.totalRepsAttempted++;
        
        const duration = now - state.repStartTime;
        const rom = state.currentRepMaxFlexion;
        const hipStable = isHipStable();
        const jerky = isJerky();
        const hyperextended = state.currentRepHyperextended;
        
        let isValid = true;
        const issues = {
            incompleteROM: false,
            tooFast: false,
            tooSlow: false,
            hyperextension: hyperextended,
            hipStability: !hipStable,
            jerky: jerky
        };
        
        if (rom < 50) {
            isValid = false;
            issues.incompleteROM = true;
            state.issues.incompleteROM++;
        }
        if (duration < CONFIG.SPEED.MIN_TIME) {
            isValid = false;
            issues.tooFast = true;
            state.issues.tooFast++;
        } else if (duration > CONFIG.SPEED.MAX_TIME) {
            issues.tooSlow = true;
            state.issues.tooSlow++;
        }
        if (!hipStable) {
            state.issues.hipStability++;
            state.hipStabilityFails++;
        }
        if (jerky) {
            state.issues.jerky++;
            state.jerkFails++;
        }
        if (hyperextended) {
            state.issues.hyperextension++;
            state.hyperextensionCount++;
        }
        
        const qualityScore = calculateRepQuality(duration, rom, smoothnessScore, hipStable, hyperextended);
        
        if (isValid) {
            state.validReps++;
            state.sumRoM += rom;
            state.sumDuration += duration;
            state.totalScore += qualityScore;
            if (rom > state.bestROM) state.bestROM = rom;
            showCoaching(getCoachingCue(true, issues), "success");
        } else {
            showCoaching(getCoachingCue(false, issues), issues.jerky || issues.hyperextension ? "danger" : "warning");
        }
        
        const repLog = {
            repNumber: state.totalRepsAttempted,
            isValid,
            minAngle: Math.round(toAnatomical(state.currentRepMinAngle)),
            rom: Math.round(rom),
            duration: duration.toFixed(1),
            smoothness: smoothnessScore > 80 ? 'Good' : smoothnessScore > 50 ? 'Fair' : 'Poor',
            hipStable: hipStable ? 'Stable' : 'Unstable',
            qualityScore,
            reason: getReasonText(issues)
        };
        state.repLogs.push(repLog);
        addRepToTable(repLog);
        
        elCurrentScore.textContent = qualityScore;
        elCurrentScore.style.color = qualityScore > 80 ? '#4ade80' : qualityScore > 60 ? '#fbbf24' : '#f87171';
        
        updateUI();
    }

    function getReasonText(issues) {
        if (issues.incompleteROM) return "Insufficient ROM";
        if (issues.tooFast) return "Too fast";
        if (issues.tooSlow) return "Too slow";
        if (issues.jerky) return "Jerky";
        if (issues.hipStability) return "Hip unstable";
        if (issues.hyperextension) return "Hyperextension";
        return "Good";
    }

    function addRepToTable(log) {
        const tbody = document.getElementById('rep-table-body');
        const row = document.createElement('tr');
        
        const statusClass = log.isValid ? 'badge-success' : 'badge-error';
        const smoothClass = log.smoothness === 'Good' ? 'badge-success' : log.smoothness === 'Fair' ? 'badge-warn' : 'badge-error';
        const hipClass = log.hipStable === 'Stable' ? 'badge-success' : 'badge-warn';
        const scoreClass = log.qualityScore > 80 ? 'score-good' : log.qualityScore > 60 ? 'score-mid' : 'score-poor';
        
        row.innerHTML = `
            <td>${log.repNumber}</td>
            <td><span class="badge ${statusClass}">${log.isValid ? 'Valid' : 'Invalid'}</span></td>
            <td>${log.minAngle}¬∞</td>
            <td>${log.rom}¬∞</td>
            <td>${log.duration}s</td>
            <td><span class="badge ${smoothClass}">${log.smoothness}</span></td>
            <td><span class="badge ${hipClass}">${log.hipStable}</span></td>
            <td><span class="score-badge ${scoreClass}">${log.qualityScore}</span></td>
            <td style="font-size:11px;color:#94a3b8;">${log.reason}</td>
        `;
        tbody.insertBefore(row, tbody.firstChild);
    }

    function updateUI() {
        elReps.textContent = state.validReps;
        elRepRatio.textContent = `${state.validReps}/${state.totalRepsAttempted}`;
    }

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }

    // ============ PDF GENERATION ============
    function generatePDF(sessionData) {
        console.log('Generating PDF for:', sessionData);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const primaryColor = [34, 211, 238];
        const textColor = [51, 51, 51];
        const lightGray = [150, 150, 150];
        
        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.text('HELIFY', 20, 25);
        doc.setFontSize(12);
        doc.text('Exercise Report', 20, 32);
        
        // Date
        doc.setTextColor(...lightGray);
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 150, 15);
        
        // Session Info
        doc.setTextColor(...textColor);
        doc.setFontSize(14);
        doc.text('Session Summary', 20, 55);
        
        doc.setFontSize(11);
        const lineHeight = 8;
        let y = 70;
        
        doc.text(`Date: ${sessionData.date}`, 20, y);
        doc.text(`Leg: ${sessionData.leg}`, 110, y);
        y += lineHeight;
        
        doc.text(`Valid Reps: ${sessionData.validReps}`, 20, y);
        doc.text(`Success Rate: ${sessionData.successRate}%`, 110, y);
        y += lineHeight;
        
        doc.text(`Average ROM: ${sessionData.avgRom}¬∞`, 20, y);
        doc.text(`Best ROM: ${sessionData.bestRom}¬∞`, 110, y);
        y += lineHeight;
        
        doc.text(`Avg Speed: ${sessionData.avgSpeed}s`, 20, y);
        doc.text(`Quality Score: ${sessionData.qualityScore}/100`, 110, y);
        y += lineHeight * 2;
        
        // Issues Section
        if (Object.values(sessionData.issueBreakdown).some(v => v > 0)) {
            doc.setFontSize(14);
            doc.text('Issues Detected', 20, y);
            y += lineHeight;
            
            doc.setFontSize(10);
            const issues = {
                incompleteROM: "Incomplete ROM",
                tooFast: "Too fast",
                tooSlow: "Too slow",
                hyperextension: "Hyperextension",
                hipStability: "Hip instability",
                jerky: "Jerky movement"
            };
            
            Object.entries(sessionData.issueBreakdown)
                .filter(([_, count]) => count > 0)
                .forEach(([key, count]) => {
                    doc.text(`‚Ä¢ ${issues[key]}: ${count} reps`, 25, y);
                    y += 6;
                });
        }
        
        // Footer
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 280, 210, 17, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text('Powered by Helify - Clinical Precision Rehab', 105, 290, { align: 'center' });
        
        console.log('PDF generated successfully');
        return doc;
    }

    function downloadPDF() {
        if (!currentSessionData) {
            showEmailStatus('No session data available', 'error');
            return;
        }
        
        try {
            const doc = generatePDF(currentSessionData);
            const filename = `helify-report-${currentSessionData.leg.toLowerCase()}-${Date.now()}.pdf`;
            doc.save(filename);
            showEmailStatus('PDF downloaded!', 'success');
            console.log('PDF downloaded:', filename);
        } catch (error) {
            console.error('PDF download failed:', error);
            showEmailStatus('Failed to download PDF', 'error');
        }
    }

    // ============ EMAIL SENDING ============
    async function sendPDFByEmail() {
        const emailInput = document.getElementById('user-email');
        const email = emailInput.value.trim();
        const statusEl = document.getElementById('email-status');
        const btn = document.getElementById('send-email-btn');
        
        console.log('Attempting to send email to:', email);
        
        // Validation
        if (!email || !isValidEmail(email)) {
            showEmailStatus('Please enter a valid email address', 'error');
            emailInput.style.borderColor = '#ef4444';
            console.log('Email validation failed');
            return;
        }
        
        if (!currentSessionData) {
            showEmailStatus('No session data available', 'error');
            console.log('No session data');
            return;
        }
        
        // Loading state
        btn.disabled = true;
        btn.textContent = 'Sending...';
        showEmailStatus('Generating PDF...', 'neutral');
        
        try {
            // Generate PDF
            const doc = generatePDF(currentSessionData);
            
            // Convert to base64 - try different methods for compatibility
            let pdfBase64;
            try {
                pdfBase64 = doc.output('datauristring').split(',')[1];
                console.log('PDF base64 length:', pdfBase64.length);
            } catch (e) {
                console.error('Base64 conversion failed:', e);
                // Fallback method
                const blob = doc.output('blob');
                pdfBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });
            }
            
            showEmailStatus('Sending email...', 'neutral');
            
            // Template parameters - match common EmailJS template variables
            const templateParams = {
                to_email: email,
                from_name: 'Helify Exercise System',
                to_name: email.split('@')[0],
                subject: `Helify Exercise Report - ${currentSessionData.leg} Leg - ${currentSessionData.date}`,
                message: `Your exercise session report is attached.\n\nSession Summary:\n‚Ä¢ Date: ${currentSessionData.date}\n‚Ä¢ Leg: ${currentSessionData.leg}\n‚Ä¢ Valid Reps: ${currentSessionData.validReps}/${currentSessionData.attemptedReps}\n‚Ä¢ Success Rate: ${currentSessionData.successRate}%\n‚Ä¢ Average ROM: ${currentSessionData.avgRom}¬∞\n‚Ä¢ Best ROM: ${currentSessionData.bestRom}¬∞\n‚Ä¢ Quality Score: ${currentSessionData.qualityScore}/100`,
                
                // Attachment parameters - common names used by EmailJS
                attachment: pdfBase64,
                pdf_attachment: pdfBase64,
                file: pdfBase64,
                pdf: pdfBase64,
                
                // Filename
                filename: `helify-report-${currentSessionData.leg.toLowerCase()}-${new Date().toISOString().split('T')[0]}.pdf`,
                pdf_filename: `helify-report-${currentSessionData.leg.toLowerCase()}-${new Date().toISOString().split('T')[0]}.pdf`
            };
            
            console.log('Sending with params:', {
                service: EMAILJS_CONFIG.SERVICE_ID,
                template: EMAILJS_CONFIG.TEMPLATE_ID,
                to_email: email,
                attachment_length: pdfBase64.length
            });
            
            // Send via EmailJS
            const response = await emailjs.send(
                EMAILJS_CONFIG.SERVICE_ID,
                EMAILJS_CONFIG.TEMPLATE_ID,
                templateParams
            );
            
            console.log('EmailJS success response:', response);
            showEmailStatus(`‚úì Report sent to ${email}`, 'success');
            emailInput.value = '';
            emailInput.style.borderColor = '#334155';
            
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'üìß Send to Email';
            }, 3000);
            
        } catch (error) {
            console.error('EmailJS error:', error);
            console.error('Error details:', {
                text: error.text,
                status: error.status
            });
            
            let errorMsg = 'Failed to send email. ';
            if (error.text && error.text.includes('template')) {
                errorMsg += 'Template variable mismatch. Check console for details.';
            } else if (error.text) {
                errorMsg += error.text;
            } else {
                errorMsg += 'Please try downloading instead.';
            }
            
            showEmailStatus(errorMsg, 'error');
            btn.disabled = false;
            btn.textContent = 'üìß Send to Email';
            
            // Show debug info
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = 'block';
            debugInfo.innerHTML = `<strong>Debug:</strong> ${error.text || error.message || 'Unknown error'}<br>Check browser console for details.`;
        }
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showEmailStatus(message, type) {
        const el = document.getElementById('email-status');
        el.textContent = message;
        el.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#94a3b8';
    }

    // ============ SESSION MANAGEMENT ============
    function finishSession() {
        if (state.validReps === 0) {
            alert("No valid reps completed yet!");
            return;
        }
        
        const avgRom = Math.round(state.sumRoM / state.validReps);
        const avgSpeed = (state.sumDuration / state.validReps).toFixed(1);
        const avgQuality = Math.round(state.totalScore / state.validReps);
        const successRate = Math.round((state.validReps / state.totalRepsAttempted) * 100);
        
        const session = {
            id: Date.now(),
            date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            leg: state.leg.toUpperCase(),
            validReps: state.validReps,
            attemptedReps: state.totalRepsAttempted,
            successRate: successRate,
            avgRom: avgRom,
            bestRom: state.bestROM,
            avgSpeed: avgSpeed,
            qualityScore: avgQuality,
            warnings: state.hyperextensionCount + state.hipStabilityFails + state.jerkFails,
            issueBreakdown: {...state.issues},
            repLogs: state.repLogs
        };
        
        let history = JSON.parse(localStorage.getItem('helify_sessions') || "[]");
        history.unshift(session);
        localStorage.setItem('helify_sessions', JSON.stringify(history.slice(0, 10)));
        
        currentSessionData = session;
        showReport(session);
        renderHistory();
        resetSession();
    }

    function showReport(session) {
        const history = JSON.parse(localStorage.getItem('helify_sessions') || "[]");
        const prevSession = history.find(s => s.id !== session.id);
        
        document.getElementById('report-subtitle').textContent = 
            `${session.date} | ${session.leg} Leg | ${session.attemptedReps} reps`;
        
        document.getElementById('report-valid').textContent = session.validReps;
        document.getElementById('report-rate').textContent = session.successRate + "%";
        document.getElementById('report-rom').textContent = session.avgRom + "¬∞";
        document.getElementById('report-score').textContent = session.qualityScore;
        document.getElementById('report-time').textContent = session.avgSpeed + "s";
        document.getElementById('report-best').textContent = session.bestRom + "¬∞";
        
        if (prevSession) {
            const repTrend = session.validReps - prevSession.validReps;
            const romTrend = session.avgRom - prevSession.avgRom;
            const scoreTrend = session.qualityScore - prevSession.qualityScore;
            
            document.getElementById('report-rep-trend').textContent = (repTrend >= 0 ? "‚Üë " : "‚Üì ") + Math.abs(repTrend);
            document.getElementById('report-rep-trend').className = "comparison " + (repTrend >= 0 ? "positive" : "negative");
            
            document.getElementById('report-rom-trend').textContent = (romTrend >= 0 ? "‚Üë " : "‚Üì ") + Math.abs(romTrend) + "¬∞";
            document.getElementById('report-rom-trend').className = "comparison " + (romTrend >= 0 ? "positive" : "negative");
            
            document.getElementById('report-score-trend').textContent = (scoreTrend >= 0 ? "‚Üë " : "‚Üì ") + Math.abs(scoreTrend) + " pts";
            document.getElementById('report-score-trend').className = "comparison " + (scoreTrend >= 0 ? "positive" : "negative");
        } else {
            document.getElementById('report-rep-trend').textContent = "First session";
            document.getElementById('report-rom-trend').textContent = "Baseline";
            document.getElementById('report-score-trend').textContent = "Baseline";
        }
        
        const issuesContainer = document.getElementById('issues-container');
        issuesContainer.innerHTML = '';
        
        const sortedIssues = Object.entries(session.issueBreakdown)
            .filter(([_, count]) => count > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
        
        if (sortedIssues.length === 0) {
            issuesContainer.innerHTML = '<div class="issue-item" style="color:#4ade80;">‚úì No major issues</div>';
        } else {
            const issueNames = {
                incompleteROM: "Incomplete ROM",
                tooFast: "Too fast",
                tooSlow: "Too slow",
                hyperextension: "Hyperextension",
                hipStability: "Hip instability",
                jerky: "Jerky movement"
            };
            
            sortedIssues.forEach(([key, count]) => {
                const div = document.createElement('div');
                div.className = 'issue-item';
                div.innerHTML = `<div class="issue-dot ${key === 'tooSlow' ? 'warning' : ''}"></div>${issueNames[key]}: ${count} reps`;
                issuesContainer.appendChild(div);
            });
        }
        
        const recList = document.getElementById('recommendations-list');
        recList.innerHTML = '';
        
        const recommendations = [];
        if (session.avgRom < 60) recommendations.push(`Target ${Math.min(70, session.avgRom + 10)}¬∞ ROM`);
        if (session.avgSpeed < 2.0) recommendations.push("Slow down: 2-4s per rep");
        if (session.avgSpeed > 5.0) recommendations.push("Speed up: complete within 4s");
        if (session.issueBreakdown.hyperextension > 0) recommendations.push("Avoid full knee lock");
        if (session.issueBreakdown.jerky > 0) recommendations.push("Smoother movements");
        if (session.issueBreakdown.hipStability > 0) recommendations.push("Stabilize hip position");
        if (recommendations.length === 0) recommendations.push("Maintain form, increase volume");
        
        recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recList.appendChild(li);
        });
        
        document.getElementById('email-status').textContent = '';
        document.getElementById('user-email').value = '';
        document.getElementById('send-email-btn').disabled = false;
        document.getElementById('send-email-btn').textContent = 'üìß Send to Email';
        
        document.getElementById('report-modal').classList.add('show');
    }

    function closeReport() {
        document.getElementById('report-modal').classList.remove('show');
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('helify_sessions') || "[]");
        const tbody = document.getElementById('history-body');
        
        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#64748b;">No sessions yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = history.map(s => {
            const scoreClass = s.qualityScore > 80 ? 'score-good' : s.qualityScore > 60 ? 'score-mid' : 'score-poor';
            return `
                <tr>
                    <td>${s.date}</td>
                    <td>${s.leg}</td>
                    <td><b>${s.validReps}/${s.attemptedReps}</b></td>
                    <td>${s.avgRom}¬∞</td>
                    <td>${s.bestRom}¬∞</td>
                    <td><span class="score-badge ${scoreClass}">${s.qualityScore}</span></td>
                    <td>${s.warnings}</td>
                </tr>
            `;
        }).join('');
    }

    // ============ MEDIAPIPE SETUP ============
    const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    
    pose.setOptions({ 
        modelComplexity: 1, 
        smoothLandmarks: true, 
        minDetectionConfidence: 0.6, 
        minTrackingConfidence: 0.6 
    });
    
    pose.onResults((results) => {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, 1280, 720);
        canvasCtx.drawImage(results.image, 0, 0, 1280, 720);

        if (results.poseLandmarks) {
            const processed = processFrame(results.poseLandmarks);
            
            if (processed) {
                const { isSafe, hip, knee, ankle, smoothnessScore } = processed;
                
                canvasCtx.lineWidth = 8;
                canvasCtx.lineCap = "round";
                canvasCtx.lineJoin = "round";
                canvasCtx.strokeStyle = isSafe ? '#22d3ee' : '#ef4444';
                
                canvasCtx.beginPath();
                canvasCtx.moveTo(hip.x * 1280, hip.y * 720);
                canvasCtx.lineTo(knee.x * 1280, knee.y * 720);
                canvasCtx.lineTo(ankle.x * 1280, ankle.y * 720);
                canvasCtx.stroke();
                
                canvasCtx.fillStyle = '#ffffff';
                [hip, knee, ankle].forEach(p => {
                    canvasCtx.beginPath();
                    canvasCtx.arc(p.x * 1280, p.y * 720, 8, 0, 2 * Math.PI);
                    canvasCtx.fill();
                });
                
                canvasCtx.strokeStyle = smoothnessScore > 80 ? '#22c55e' : smoothnessScore > 50 ? '#f59e0b' : '#ef4444';
                canvasCtx.lineWidth = 3;
                canvasCtx.beginPath();
                canvasCtx.arc(knee.x * 1280, knee.y * 720, 30, 0, 2 * Math.PI);
                canvasCtx.stroke();
            }
        }
        canvasCtx.restore();
    });

    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 1280, height: 720
    });
    
    init();
    camera.start();
</script>
</body>
</html>
